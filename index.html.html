<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulador Face ID — Tarjeta Blanca</title>
  <style>
    :root{--bg:#f5f5f5;--card:#ffffff;--accent:#10b981;--text:#333;--muted:#666}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;min-height:100vh;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;color:var(--text)}
    .wrap{width:100%;max-width:800px;background:var(--card);border-radius:16px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .cols{display:flex;gap:18px;margin-top:14px}
    .left{flex:0 0 480px;position:relative}
    video{width:100%;height:320px;object-fit:cover;border-radius:12px;background:#ddd}
    canvas{position:absolute;left:0;top:0}
    .right{flex:1;display:flex;flex-direction:column;gap:12px}
    .status{padding:16px;border-radius:12px;background:rgba(16,185,129,0.08);font-weight:600;text-align:center; font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .btn{background:transparent;border:1px solid rgba(0,0,0,0.12);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;color:var(--text)}
    .note{color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Simulador Face ID</h1>
      <div style="color:var(--muted)">Educativo • No almacena imágenes</div>
    </div>

    <div class="cols">
      <div class="left">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay" width="480" height="320"></canvas>
      </div>

      <div class="right">
        <div class="status" id="stateText">Bloqueado</div>
        <div class="controls">
          <button class="btn" id="startBtn">Iniciar cámara</button>
          <button class="btn" id="stopBtn">Detener</button>
          <button class="btn" id="fakeBtn">Simular rostro</button>
        </div>
        <div class="note">Coloca tu rostro centrado en la cámara o usa "Simular rostro" si tu navegador no soporta detección facial.</div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fakeBtn = document.getElementById('fakeBtn');
    const stateText = document.getElementById('stateText');

    let stream = null;
    let detector = null;
    let running = false;
    let unlocked = false;

    function setLocked(v){
      unlocked = v;
      stateText.textContent = v ? 'Bienvenido al sistema.' : 'Bloqueado';
    }

    async function initDetector(){
      if ('FaceDetector' in window){
        detector = new FaceDetector({fastMode:true,maxDetectedFaces:1});
        console.log('FaceDetector activo');
      } else {
        detector = null;
        console.log('No hay FaceDetector — usar simulación');
      }
    }

    async function startCamera(){
      if (running) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{width:480,height:320},audio:false});
        video.srcObject = stream;
        await video.play();
        overlay.width = video.videoWidth || 480;
        overlay.height = video.videoHeight || 320;
        running = true;
        loop();
      }catch(e){
        alert('No se pudo acceder a la cámara: ' + e.message);
      }
    }

    function stopCamera(){
      running = false;
      if (stream){stream.getTracks().forEach(t=>t.stop());stream=null}
      ctx.clearRect(0,0,overlay.width,overlay.height);
      setLocked(false);
    }

    async function loop(){
      if (!running) return;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if (detector){
        try{
          const faces = await detector.detect(video);
          if (faces && faces.length>0){
            const f = faces[0].boundingBox;
            ctx.strokeStyle = 'rgba(16,185,129,0.95)';
            ctx.lineWidth = 3;
            ctx.strokeRect(f.x,f.y,f.width,f.height);
            const centerX = f.x + f.width/2;
            const centerY = f.y + f.height/2;
            const inCenter = Math.abs(centerX - overlay.width/2) < overlay.width*0.2 && Math.abs(centerY - overlay.height/2) < overlay.height*0.2;
            const bigEnough = f.width > overlay.width*0.25;
            if (inCenter && bigEnough){
              setLocked(true);
            } else {
              setLocked(false);
            }
          } else {
            setLocked(false);
          }
        }catch(e){console.warn('Error detector:',e);}
      }
      requestAnimationFrame(loop);
    }

    startBtn.addEventListener('click', async ()=>{ await initDetector(); await startCamera(); });
    stopBtn.addEventListener('click', ()=>stopCamera());
    fakeBtn.addEventListener('click', ()=>{ setLocked(true); setTimeout(()=>setLocked(false),2000); });

    initDetector();
  </script>
</body>
</html>
